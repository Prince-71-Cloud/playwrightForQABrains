name: Playwright Tests with Allure Reports

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests
      run: npx playwright test
      env:
        ALLURE_RESULTS_DIR: allure-results

    - name: Generate Allure Report
      uses: simple-elf/allure-report-action@v1.6
      if: always()
      with:
        allure_results: allure-results
        allure_report: allure-report
        allure_history: allure-history

    - name: Archive Allure Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-report
        path: allure-report

    - name: Send Email with Allure Report
      uses: dawidd6/action-send-mail@v3
      if: always()
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: Playwright Test Report - ${{ github.repository }} - ${{ github.ref_name }} - ${{ github.sha }}
        to: bhuiyanaman71@gmail.com
        from: Playwright Tests
        html_body: |
          <h2>Playwright Test Results</h2>
          <p>Tests were executed for repository: <strong>${{ github.repository }}</strong></p>
          <p>Branch: <strong>${{ github.ref_name }}</strong></p>
          <p>Commit SHA: <strong>${{ github.sha }}</strong></p>
          <p>Status: <strong>${{ job.status }}</strong></p>
          <p>Please find attached the Allure test report for detailed results.</p>
        attachments: |
          allure-report/index.html